# アーキテクチャ概要

## プロジェクト概要

Devport は「AI 編集をメイン、手動編集をサブ」というコンセプトのモバイル向けプログラミングプラットフォーム。ユーザーは小さな画面でコードエディタを操作するのではなく、自然言語で AI と対話して開発を行う。

## システム構成

```
┌─────────────────────────────────────────────────────────────────────┐
│                         モバイル端末                                  │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                    React SPA (フロントエンド)                    │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐   │  │
│  │  │   Zustand   │  │ React Query │  │  TanStack Router    │   │  │
│  │  │  (状態管理)  │  │ (サーバー状態) │  │  (ファイルベース)    │   │  │
│  │  └─────────────┘  └─────────────┘  └─────────────────────┘   │  │
│  └───────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ WebSocket (JSON-RPC 2.0)
                                   ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    cloud.devport.app (リレーサーバー)                   │
│                         NAT越え・接続中継                             │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ WebSocket (常時接続)
                                   ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       ローカル PC (NAT 内)                           │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                    Go Server (バックエンド)                      │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐    │  │
│  │  │ WebSocket RPC │  │ Process Mgr  │  │ Worktree Mgr    │    │  │
│  │  │  (JSON-RPC)   │  │ (セッション)   │  │ (Git worktree)  │    │  │
│  │  └──────────────┘  └──────────────┘  └──────────────────┘    │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                   │                                  │
│                                   │ stdin/stdout (stream-json)       │
│                                   ▼                                  │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                      Claude CLI (サブプロセス)                   │  │
│  └───────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

## 技術スタック

### フロントエンド (`web/`)

| カテゴリ | 技術 | バージョン | 用途 |
|---------|------|-----------|------|
| フレームワーク | React | 19.x | UI構築 |
| ビルドツール | Vite | 7.x | 高速HMR、Brotli圧縮 |
| 言語 | TypeScript | 5.x | 型安全 |
| スタイリング | Tailwind CSS | 4.x | ユーティリティファースト |
| 状態管理 | Zustand | 5.x | クライアント状態 |
| サーバー状態 | React Query | 5.x | キャッシュ・同期 |
| ルーティング | TanStack Router | 1.x | ファイルベース |
| RPC | json-rpc-2.0 | 1.x | JSON-RPC クライアント |
| Linter/Formatter | Biome | 2.x | ESLint + Prettier 代替 |

### バックエンド (`server/`)

| カテゴリ | 技術 | バージョン | 用途 |
|---------|------|-----------|------|
| 言語 | Go | 1.25.x | サーバー実装 |
| HTTP | net/http | 標準 | HTTP サーバー |
| WebSocket | coder/websocket | 1.x | WebSocket 通信 |
| JSON-RPC | sourcegraph/jsonrpc2 | 0.2.x | RPC ハンドラ |
| ファイル監視 | fsnotify | 1.x | ファイル変更検知 |
| UUID | google/uuid | 1.x | セッション ID |

### AI 統合

| 要素 | 実装 |
|------|------|
| AI エンジン | Claude CLI（サブプロセス） |
| 通信形式 | `--output-format stream-json` |
| 入力形式 | `--input-format stream-json` |
| 権限管理 | `--permission-prompt-tool stdio` |

## 通信フロー

### WebSocket JSON-RPC 2.0

全ての通信は WebSocket 上の JSON-RPC 2.0 で行う。REST API は使用しない。

```
クライアント                    サーバー
    │                              │
    │─── auth ────────────────────►│  認証
    │◄── result ──────────────────│
    │                              │
    │─── chat.attach ─────────────►│  セッション接続
    │◄── result ──────────────────│
    │                              │
    │─── chat.message ────────────►│  メッセージ送信
    │                              │
    │◄── chat.text (notification)──│  AIテキスト出力
    │◄── chat.text (notification)──│  （ストリーミング）
    │◄── chat.tool_call ──────────│  ツール呼び出し
    │◄── chat.tool_result ────────│  ツール結果
    │◄── chat.done ───────────────│  応答完了
    │                              │
```

### メソッド一覧

**クライアント → サーバー（リクエスト）:**

| メソッド | 用途 |
|---------|------|
| `auth` | トークン認証 |
| `chat.attach` | セッション接続 |
| `chat.message` | メッセージ送信 |
| `chat.interrupt` | AI処理中断 |
| `chat.permission_response` | 権限リクエストへの応答 |
| `chat.question_response` | ユーザー質問への応答 |
| `session.list` | セッション一覧取得 |
| `session.create` | 新規セッション作成 |
| `session.delete` | セッション削除 |
| `file.get` | ファイル内容取得 |
| `git.status` | Git ステータス取得 |
| `git.diff` | Git diff 取得 |
| `worktree.list` | ワークツリー一覧 |

**サーバー → クライアント（通知）:**

| メソッド | 用途 |
|---------|------|
| `chat.text` | AIテキスト出力 |
| `chat.tool_call` | ツール呼び出し開始 |
| `chat.tool_result` | ツール実行結果 |
| `chat.error` | エラー発生 |
| `chat.done` | 応答完了 |
| `chat.permission_request` | 権限リクエスト |
| `chat.ask_user_question` | ユーザーへの質問 |
| `chat.system` | システムメッセージ |

## プロジェクト構造

```
devport/
├── web/                    # React フロントエンド
│   ├── src/
│   │   ├── components/     # UIコンポーネント
│   │   │   ├── Chat/       # チャットUI
│   │   │   ├── Files/      # ファイルブラウザ
│   │   │   ├── Git/        # Git diff ビューア
│   │   │   └── ui/         # 共通UIパーツ
│   │   ├── lib/            # ユーティリティ
│   │   │   ├── wsStore.ts  # WebSocket + RPC 状態管理
│   │   │   └── rpc.ts      # JSON-RPC クライアント
│   │   ├── routes/         # TanStack Router ルート
│   │   └── hooks/          # カスタムフック
│   └── vite.config.ts
│
├── server/                 # Go バックエンド
│   ├── main.go             # エントリーポイント
│   ├── agent/              # AI エージェント
│   │   ├── agent.go        # インターフェース
│   │   └── claude/         # Claude CLI 実装
│   ├── ws/                 # WebSocket RPC
│   │   ├── rpc.go          # RPC ハンドラ
│   │   ├── rpc_chat.go     # チャット関連
│   │   ├── rpc_file.go     # ファイル操作
│   │   └── rpc_git.go      # Git 操作
│   ├── process/            # プロセス管理
│   ├── relay/              # リレー接続
│   └── worktree/           # ワークツリー管理
│
├── site/                   # devport.app（Hugo）
└── docs/                   # ドキュメント
```

## Claude CLI 統合

### プロセスライフサイクル

```
┌─────────────────────────────────────────────────────────────┐
│                    セッション開始                             │
│  exec.Command("claude",                                      │
│      "--output-format", "stream-json",                       │
│      "--input-format", "stream-json",                        │
│      "--permission-prompt-tool", "stdio",                    │
│      "--session-id", sessionID)                              │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    イベントストリーミング                      │
│  stdout → JSON パース → イベント変換 → WebSocket ブロードキャスト │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    終了条件                                  │
│  - アイドルタイムアウト（デフォルト10分）                       │
│  - 明示的な終了リクエスト                                     │
│  - コンテキストキャンセル                                     │
└─────────────────────────────────────────────────────────────┘
```

### 特徴

- **遅延起動**: セッションごとにプロセスを遅延作成
- **参照カウント**: 複数接続で同一プロセスを共有
- **アイドルタイムアウト**: 無操作時に自動クリーンアップ
- **パニックリカバリ**: goroutine のパニックをログ記録して継続

## データストレージ

| データ | 保存先 | 形式 |
|--------|-------|------|
| セッションメタデータ | メモリ | Go struct |
| セッション履歴 | `.devport/sessions/` | JSON |
| リレー設定 | `~/.devport/relay/` | JSON |
| コマンド履歴 | `.devport/commands/` | JSON |

**注**: 外部データベースは使用しない（ファイルシステムベース）。

## セキュリティ

### 認証

- Bearer トークン認証（`AUTH_TOKEN` 環境変数）
- WebSocket 接続時に `auth` メソッドで認証
- `crypto/subtle.ConstantTimeCompare` でタイミング攻撃対策

### 考慮事項

- パストラバーサル攻撃への対策（パス検証）
- Claude CLI へのプロンプトインジェクション対策
- リレー経由の通信は HTTPS/WSS
